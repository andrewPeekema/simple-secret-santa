<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #222222;
            --bg-elevated: #282828;
            --text-primary: #f5f5f4;
            --text-secondary: #a8a8a6;
            --text-muted: #6b6b69;
            --green: #3a9a5c;
            --green-light: #4db870;
            --green-dark: #2d7a48;
            --green-subtle: rgba(58, 154, 92, 0.12);
            --green-border: rgba(58, 154, 92, 0.4);
            --red: #c54545;
            --red-light: #d46a6a;
            --red-subtle: rgba(197, 69, 69, 0.12);
            --red-border: rgba(197, 69, 69, 0.4);
            --success: #3a9a5c;
            --success-bg: rgba(58, 154, 92, 0.12);
            --error: #c54545;
            --error-bg: rgba(197, 69, 69, 0.1);
            --warning: #c54545;
            --warning-bg: rgba(197, 69, 69, 0.1);
            --warning-border: rgba(197, 69, 69, 0.4);
            --border: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --font-serif: 'Libre Baskerville', Georgia, serif;
            --font-sans: 'DM Sans', -apple-system, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            max-width: 580px;
            margin: 0 auto;
            padding: 24px 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 32px 28px;
            animation: fadeIn 0.6s ease-out;
        }

        h1 {
            font-family: var(--font-serif);
            font-weight: 400;
            font-size: 1.9rem;
            color: var(--text-primary);
            text-align: center;
            margin: 0 0 4px 0;
            letter-spacing: -0.01em;
        }

        h1::before {
            content: "✦";
            display: block;
            color: var(--green);
            font-size: 1rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        h3 {
            font-family: var(--font-serif);
            font-weight: 400;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 20px 0 10px 0;
        }

        .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 0.9rem;
            font-style: italic;
            font-family: var(--font-serif);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            margin: 4px 0;
            border: 1px solid var(--border-light);
            border-radius: 2px;
            font-size: 14px;
            font-family: var(--font-sans);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--green-border);
            background: var(--bg-elevated);
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        button {
            width: 100%;
            padding: 10px 20px;
            margin: 6px 0;
            border: 1px solid var(--green-dark);
            border-radius: 2px;
            font-size: 13px;
            font-family: var(--font-sans);
            font-weight: 500;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            background: transparent;
            color: var(--green);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        button:hover {
            background: var(--green);
            color: var(--bg-primary);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .person-input {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 3px 0;
        }

        .person-input input {
            flex: 1;
        }

        .remove-btn {
            width: auto;
            padding: 8px 14px;
            border-color: var(--red);
            color: var(--red);
            font-size: 12px;
        }

        .remove-btn:hover {
            background: var(--red);
            color: var(--text-primary);
        }

        .remove-exclusion-btn {
            border-color: var(--red) !important;
            color: var(--red) !important;
        }

        .remove-exclusion-btn:hover {
            background: var(--red) !important;
            color: var(--text-primary) !important;
        }

        #results {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 2px;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .link-item {
            margin: 12px 0;
            padding: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 2px;
            animation: fadeIn 0.4s ease-out;
            animation-fill-mode: both;
        }

        .link-item:nth-child(1) { animation-delay: 0.1s; }
        .link-item:nth-child(2) { animation-delay: 0.15s; }
        .link-item:nth-child(3) { animation-delay: 0.2s; }
        .link-item:nth-child(4) { animation-delay: 0.25s; }
        .link-item:nth-child(5) { animation-delay: 0.3s; }

        .link-item strong {
            display: block;
            margin-bottom: 8px;
            color: var(--green-light);
            font-family: var(--font-serif);
            font-weight: 400;
            font-size: 1rem;
        }

        .link-item input {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 8px 10px;
        }

        .copy-btn {
            width: auto;
            padding: 8px 16px;
            margin-top: 8px;
            border-color: var(--green);
            color: var(--green);
            font-size: 11px;
        }

        .copy-btn:hover {
            background: var(--green);
            color: var(--text-primary);
        }

        #revealSection, #hintsSection, #viewHintsSection {
            text-align: center;
            padding: 12px 0;
        }

        .reveal-box {
            background: var(--green-subtle);
            border: 1px solid var(--green-border);
            border-radius: 2px;
            padding: 28px 24px;
            margin: 20px 0;
        }

        .reveal-box h2 {
            font-family: var(--font-serif);
            font-weight: 400;
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .reveal-name {
            font-family: var(--font-serif);
            font-size: 1.8rem;
            color: var(--red-light);
            font-weight: 700;
            margin: 16px 0;
        }

        .error {
            background: var(--error-bg);
            color: var(--error);
            padding: 12px 16px;
            border: 1px solid var(--red-border);
            border-radius: 2px;
            margin: 12px 0;
            font-size: 13px;
        }

        .warning {
            background: var(--warning-bg);
            color: var(--red-light);
            padding: 12px 16px;
            border: 1px solid var(--warning-border);
            border-radius: 2px;
            margin: 16px 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .exclusions-section {
            margin-top: 24px;
            padding: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 2px;
        }

        .exclusions-section h3 {
            margin: 0 0 4px 0;
            font-size: 1rem;
        }

        .exclusion-row {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            align-items: center;
        }

        .exclusion-row select {
            flex: 1;
        }

        .exclusion-row .remove-exclusion-btn {
            width: auto;
            padding: 8px 12px;
        }

        .add-exclusion-btn {
            border-color: var(--green);
            color: var(--green);
            margin-top: 10px;
        }

        .add-exclusion-btn:hover {
            border-color: var(--green);
            background: var(--green);
            color: var(--bg-primary);
        }

        .arrow {
            color: var(--text-muted);
            font-size: 16px;
            padding: 0 2px;
        }

        .help-text {
            color: var(--text-muted);
            font-size: 12px;
            margin: 2px 0 10px 0;
        }

        .hints-box {
            background: var(--green-subtle);
            border: 1px solid var(--green-border);
            border-radius: 2px;
            padding: 20px;
            margin: 20px 0;
        }

        .hints-box h3 {
            color: var(--green-light);
            margin: 0 0 4px 0;
        }

        .hints-box p {
            color: var(--text-secondary);
        }

        .hint-link-display {
            background: var(--bg-tertiary);
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 2px;
            margin: 14px 0;
        }

        .hint-link-display h3 {
            color: var(--green);
            font-family: var(--font-serif);
            margin: 0 0 4px 0;
        }

        .success {
            background: var(--success-bg);
            color: var(--text-primary);
            padding: 18px;
            border: 1px solid var(--green-border);
            border-radius: 2px;
            margin: 12px 0;
        }

        .success h3 {
            color: var(--green);
            margin: 0 0 12px 0;
        }

        .success div {
            background: var(--bg-tertiary) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border);
        }

        .info-box {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 2px;
            margin: 12px 0;
            font-size: 12px;
            line-height: 1.6;
            text-align: left;
        }

        .create-hints-btn {
            border-color: var(--green);
            color: var(--green);
            margin-top: 14px;
        }

        .create-hints-btn:hover {
            background: var(--green);
            color: var(--bg-primary);
        }

        .success-banner {
            background: var(--success-bg);
            border: 1px solid var(--green-border);
            color: var(--green);
            padding: 12px 16px;
            border-radius: 2px;
            margin-bottom: 16px;
            font-weight: 500;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .how-it-works {
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .how-it-works summary {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: var(--text-secondary);
            letter-spacing: 0.03em;
            text-transform: uppercase;
            list-style: none;
            transition: color 0.2s ease;
        }

        .how-it-works summary:hover {
            color: var(--text-primary);
        }

        .how-it-works summary::-webkit-details-marker {
            display: none;
        }

        .how-it-works summary::before {
            content: "✦";
            display: inline-block;
            margin-right: 8px;
            font-size: 9px;
            color: var(--green);
            transition: transform 0.3s ease;
        }

        .how-it-works[open] summary::before {
            transform: rotate(90deg);
        }

        .how-it-works-content {
            padding: 16px;
            background: var(--bg-secondary);
            font-size: 13px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
        }

        .how-it-works-content ol {
            margin: 0;
            padding-left: 18px;
        }

        .how-it-works-content li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .how-it-works-content strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        .how-it-works-content p {
            margin: 14px 0 0 0;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Password display box */
        div[style*="background: var(--bg-tertiary)"] strong {
            color: var(--green-light) !important;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Selection */
        ::selection {
            background: var(--green);
            color: var(--bg-primary);
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            body {
                padding: 12px 8px;
            }
            
            .container {
                padding: 24px 18px;
            }

            h1 {
                font-size: 1.6rem;
            }

            .exclusion-row {
                flex-wrap: wrap;
            }

            .exclusion-row select {
                min-width: 100%;
            }

            .arrow {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simple Secret Santa</h1>
        <p class="subtitle">People picking through practically private pairings</p>
        
        <div id="setupSection">
            <details class="how-it-works">
                <summary>How It Works</summary>
                <div class="how-it-works-content">
                    <ol>
                        <li><strong>Generate pairings</strong> by entering participant names below</li>
                        <li><strong>Share each link privately</strong> with the right person</li>
                        <li><strong>Each person sees their assignment</strong> and gets a wishlist password</li>
                        <li><strong>Wishlists are optional</strong>—if shared, only the right Santa can unlock them</li>
                    </ol>
                    <p>
                        This site doesn't store or collect any data—everything runs locally in your browser.
                    </p>
                </div>
            </details>

            <h3>Participants</h3>
            <div id="peopleList">
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
            </div>
            <button onclick="addPerson()">+ Add Person</button>
            
            <div class="exclusions-section">
                <h3>Exclusions <span style="font-weight: 400; color: var(--text-muted); font-size: 0.8em;">(Optional)</span></h3>
                <p class="help-text">Prevent certain pairings (couples, family members, etc.)</p>
                <div id="exclusionsList"></div>
                <button class="add-exclusion-btn" onclick="addExclusion()">+ Add Exclusion</button>
            </div>
            
            <button onclick="generateSecretSanta()" style="margin-top: 20px; border-color: var(--green); color: var(--green);">
                Generate Pairings
            </button>
            
            <div id="results" style="display: none;">
                <div id="successBanner" class="success-banner"></div>
                <h3>Distribution Links</h3>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">
                    Send each link privately to the corresponding person.
                </p>
                <button id="copyAllBtn" class="copy-btn" style="width: 100%; margin-bottom: 20px;" onclick="copyAllLinks()">Copy All Links</button>
                <div id="linksList"></div>
                <div class="warning">
                    Save these links. Once you leave this page, these specific pairings cannot be recreated.
                </div>
                </div>
            </div>
        </div>

        <div id="revealSection" style="display: none;">
        </div>

        <div id="hintsSection" style="display: none;">
        </div>

        <div id="viewHintsSection" style="display: none;">
        </div>
    </div>

    <script>
        // Store the secret salt used for this session
        let sessionSalt = Math.random().toString(36).substring(2, 15);

        // ============================================
        // COMPRESSION SUPPORT DETECTION
        // ============================================
        
        // Check if browser supports CompressionStream with deflate-raw
        const supportsCompression = (async () => {
            try {
                if (typeof CompressionStream === 'undefined') return false;
                // Test that deflate-raw specifically works
                const testStream = new CompressionStream('deflate-raw');
                return true;
            } catch (e) {
                return false;
            }
        })();

        // Format header bytes
        const FORMAT_UNCOMPRESSED = 0x00;
        const FORMAT_DEFLATE_RAW = 0x01;

        // ============================================
        // COMPRESSION FUNCTIONS
        // ============================================

        async function compressBytes(data) {
            const hasCompression = await supportsCompression;
            if (!hasCompression) {
                // Return uncompressed with header
                const result = new Uint8Array(data.length + 1);
                result[0] = FORMAT_UNCOMPRESSED;
                result.set(data, 1);
                return result;
            }

            try {
                const stream = new CompressionStream('deflate-raw');
                const writer = stream.writable.getWriter();
                writer.write(data);
                writer.close();

                const chunks = [];
                const reader = stream.readable.getReader();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                }

                // Calculate total length
                const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
                const compressed = new Uint8Array(totalLength + 1);
                compressed[0] = FORMAT_DEFLATE_RAW;
                
                let offset = 1;
                for (const chunk of chunks) {
                    compressed.set(chunk, offset);
                    offset += chunk.length;
                }

                // Only use compression if it actually saves space
                if (compressed.length < data.length + 1) {
                    return compressed;
                } else {
                    const result = new Uint8Array(data.length + 1);
                    result[0] = FORMAT_UNCOMPRESSED;
                    result.set(data, 1);
                    return result;
                }
            } catch (e) {
                // Fallback to uncompressed
                const result = new Uint8Array(data.length + 1);
                result[0] = FORMAT_UNCOMPRESSED;
                result.set(data, 1);
                return result;
            }
        }

        async function decompressBytes(data) {
            if (data.length === 0) return new Uint8Array(0);

            const format = data[0];
            const payload = data.slice(1);

            if (format === FORMAT_UNCOMPRESSED) {
                return payload;
            }

            if (format === FORMAT_DEFLATE_RAW) {
                try {
                    const stream = new DecompressionStream('deflate-raw');
                    const writer = stream.writable.getWriter();
                    writer.write(payload);
                    writer.close();

                    const chunks = [];
                    const reader = stream.readable.getReader();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                    }

                    const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
                    const result = new Uint8Array(totalLength);
                    let offset = 0;
                    for (const chunk of chunks) {
                        result.set(chunk, offset);
                        offset += chunk.length;
                    }
                    return result;
                } catch (e) {
                    console.error('Decompression failed:', e);
                    return null;
                }
            }

            // Unknown format - try treating entire data as legacy uncompressed
            return data;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function utf8ToBytes(str) {
            return new TextEncoder().encode(str);
        }

        function bytesToUtf8(bytes) {
            return new TextDecoder().decode(bytes);
        }

        function bytesToUrlSafeBase64(bytes) {
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function urlSafeBase64ToBytes(str) {
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) base64 += '=';
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        // Legacy decoding for backward compatibility
        function legacyDecode(str) {
            try {
                while (str.length % 4) str += '=';
                return decodeURIComponent(atob(str));
            } catch (e) {
                return null;
            }
        }

        async function copyToClipboard(text, button) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                
                const originalText = button.textContent;
                const originalBg = button.style.background;
                button.textContent = 'Copied!';
                button.style.background = '#38a169';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = originalBg || '#48bb78';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select and copy manually.');
            }
        }

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // CRC16-CCITT for hint validation (replaces VALID: prefix, saves 4 bytes)
        function crc16(bytes) {
            let crc = 0xFFFF;
            for (let i = 0; i < bytes.length; i++) {
                crc ^= bytes[i] << 8;
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ 0x1021;
                    } else {
                        crc <<= 1;
                    }
                }
            }
            return crc & 0xFFFF;
        }

        // ============================================
        // ENCODING FUNCTIONS
        // ============================================

        function encodeAssignment(data) {
            // Pipe-delimited format: giver|receiver|salt (key removed - was unused)
            const compact = data.giver + '|' + data.receiver + '|' + data.salt;
            const bytes = utf8ToBytes(compact);
            return bytesToUrlSafeBase64(bytes);
        }

        function decodeAssignment(encoded) {
            // Try pipe-delimited format first (new default)
            try {
                const bytes = urlSafeBase64ToBytes(encoded);
                const decoded = bytesToUtf8(bytes);
                if (decoded.includes('|') && !decoded.includes('{')) {
                    const parts = decoded.split('|');
                    if (parts.length === 3) {
                        // New format: giver|receiver|salt
                        return { giver: parts[0], receiver: parts[1], salt: parts[2] };
                    }
                    if (parts.length === 4) {
                        // Old format: giver|receiver|key|salt (key is ignored)
                        return { giver: parts[0], receiver: parts[1], salt: parts[3] };
                    }
                }
            } catch (e) {}
            
            // Try JSON format (backward compatibility)
            try {
                const bytes = urlSafeBase64ToBytes(encoded);
                const json = bytesToUtf8(bytes);
                const data = JSON.parse(json);
                if (data.giver && data.receiver) {
                    return data;
                }
            } catch (e) {}
            
            // Fall back to legacy format
            try {
                const legacy = legacyDecode(encoded);
                if (legacy) return JSON.parse(legacy);
            } catch (e) {}
            
            return null;
        }

        function xorEncrypt(bytes, key) {
            const keyBytes = utf8ToBytes(key);
            const result = new Uint8Array(bytes.length);
            for (let i = 0; i < bytes.length; i++) {
                result[i] = bytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return result;
        }

        // XOR is symmetric
        const xorDecrypt = xorEncrypt;

        async function encodeHints(plaintext, password) {
            const plaintextBytes = utf8ToBytes(plaintext);
            
            // Prepend 2-byte CRC16 checksum for validation (replaces VALID: prefix)
            const checksum = crc16(plaintextBytes);
            const withChecksum = new Uint8Array(plaintextBytes.length + 2);
            withChecksum[0] = (checksum >> 8) & 0xFF;  // High byte
            withChecksum[1] = checksum & 0xFF;         // Low byte
            withChecksum.set(plaintextBytes, 2);
            
            const compressed = await compressBytes(withChecksum);
            const encrypted = xorEncrypt(compressed, password);
            return bytesToUrlSafeBase64(encrypted);
        }

        async function decodeHints(encoded) {
            // Check for legacy format (starts with JSON pattern after decode)
            if (encoded.startsWith('JTdC')) {
                try {
                    const legacy = legacyDecode(encoded);
                    if (legacy) {
                        const json = JSON.parse(legacy);
                        const binary = atob(json.encrypted);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        // Legacy format has no compression header
                        return { bytes, isLegacy: true };
                    }
                } catch (e) {}
            }
            
            // New format
            try {
                const bytes = urlSafeBase64ToBytes(encoded);
                return { bytes, isLegacy: false };
            } catch (e) {
                return null;
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function addPerson() {
            const peopleList = document.getElementById('peopleList');
            const div = document.createElement('div');
            div.className = 'person-input';
            div.innerHTML = `
                <input type="text" placeholder="Enter name" class="person-name">
                <button class="remove-btn" onclick="this.parentElement.remove(); updateExclusionDropdowns();">Remove</button>
            `;
            peopleList.appendChild(div);
        }

        function addExclusion() {
            const exclusionsList = document.getElementById('exclusionsList');
            const div = document.createElement('div');
            div.className = 'exclusion-row';
            div.innerHTML = `
                <select class="person1-select">
                    <option value="">Select person...</option>
                </select>
                <span class="arrow">↔</span>
                <select class="person2-select">
                    <option value="">Select person...</option>
                </select>
                <button class="remove-exclusion-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            exclusionsList.appendChild(div);
            updateExclusionDropdowns();
        }

        function updateExclusionDropdowns() {
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) people.push(name);
            });

            const selects = document.querySelectorAll('.person1-select, .person2-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select person...</option>';
                people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    if (person === currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        function getExclusions() {
            const exclusions = {};
            const rows = document.querySelectorAll('.exclusion-row');
            
            rows.forEach(row => {
                const person1 = row.querySelector('.person1-select').value;
                const person2 = row.querySelector('.person2-select').value;
                
                if (person1 && person2 && person1 !== person2) {
                    if (!exclusions[person1]) exclusions[person1] = [];
                    if (!exclusions[person2]) exclusions[person2] = [];
                    
                    if (!exclusions[person1].includes(person2)) exclusions[person1].push(person2);
                    if (!exclusions[person2].includes(person1)) exclusions[person2].push(person1);
                }
            });
            
            return exclusions;
        }

        function isValidAssignment(givers, receivers, exclusions) {
            for (let i = 0; i < givers.length; i++) {
                if (givers[i] === receivers[i]) return false;
                if (exclusions[givers[i]] && exclusions[givers[i]].includes(receivers[i])) return false;
            }
            return true;
        }

        function generateSecretSanta() {
            updateExclusionDropdowns();
            
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) people.push(name);
            });

            if (people.length < 3) {
                alert('You need at least 3 people for Secret Santa!');
                return;
            }

            if (new Set(people).size !== people.length) {
                alert('Please make sure all names are unique!');
                return;
            }

            // Check for case-insensitive duplicates
            const lowerCaseNames = people.map(n => n.toLowerCase());
            const lowerCaseSet = new Set(lowerCaseNames);
            if (lowerCaseSet.size !== people.length) {
                const duplicates = people.filter((name, i) => 
                    lowerCaseNames.indexOf(name.toLowerCase()) !== i
                );
                if (!confirm(`Warning: Some names differ only by capitalization (e.g., "${duplicates[0]}"). This might cause confusion. Continue anyway?`)) {
                    return;
                }
            }

            const exclusions = getExclusions();
            
            for (let person of people) {
                const excluded = exclusions[person] || [];
                if (excluded.length >= people.length - 1) {
                    alert(`${person} has too many exclusions! They need at least one person they can give to.`);
                    return;
                }
            }

            let givers = [...people];
            let receivers = null;
            let attempts = 0;
            const maxAttempts = 1000;
            
            sessionSalt = Math.random().toString(36).substring(2, 15);
            
            while (attempts < maxAttempts) {
                receivers = shuffle([...people]);
                if (isValidAssignment(givers, receivers, exclusions)) break;
                attempts++;
            }
            
            if (attempts === maxAttempts) {
                alert('Could not generate a valid Secret Santa with these exclusions. Try removing some exclusion rules.');
                return;
            }

            const assignments = {};
            for (let i = 0; i < givers.length; i++) {
                const data = {
                    giver: givers[i],
                    receiver: receivers[i],
                    salt: sessionSalt
                };
                assignments[givers[i]] = {
                    encoded: encodeAssignment(data)
                };
            }

            displayResults(assignments);
        }

        function displayResults(assignments) {
            const linksList = document.getElementById('linksList');
            linksList.innerHTML = '';

            const people = Object.keys(assignments);
            
            // Store for Copy All function
            window.generatedLinks = [];
            
            // Set success banner
            const successBanner = document.getElementById('successBanner');
            successBanner.textContent = `✓ ${people.length} links ready to share`;

            people.forEach(person => {
                const url = window.location.origin + window.location.pathname + 
                           '#' + assignments[person].encoded;
                
                // Store for Copy All
                window.generatedLinks.push({ name: person, url: url });
                
                const div = document.createElement('div');
                div.className = 'link-item';
                
                const inputId = 'link-' + Math.random().toString(36).substring(2, 8);
                
                div.innerHTML = `
                    <strong>${escapeHtml(person)}'s link</strong>
                    <input type="text" value="${escapeHtml(url)}" readonly id="${inputId}">
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('${inputId}').value, this)">Copy Link</button>
                `;
                
                linksList.appendChild(div);
            });

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            // Auto-scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function copyAllLinks() {
            if (!window.generatedLinks || window.generatedLinks.length === 0) return;
            
            const text = window.generatedLinks
                .map(item => `${item.name}'s link:\n${item.url}`)
                .join('\n\n');
            
            copyToClipboard(text, document.getElementById('copyAllBtn'));
        }

        function revealAssignment(data) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            const hintPassword = simpleHash('pair-' + data.receiver + '-' + (data.salt || sessionSalt)).padStart(6, '0').substring(0, 6);
            
            const safeGiver = escapeHtml(data.giver);
            const safeReceiver = escapeHtml(data.receiver);
            const safeSalt = escapeHtml(data.salt || sessionSalt);
            
            revealSection.innerHTML = `
                <h1>Your Assignment</h1>
                <div class="reveal-box">
                    <h2>Hello, ${safeGiver}</h2>
                    <p style="font-size: 15px; margin: 16px 0 4px 0; color: var(--text-secondary);">You are giving a gift to</p>
                    <div class="reveal-name">${safeReceiver}</div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 2px; margin-top: 20px; border: 1px solid var(--border);">
                        <p style="color: var(--text-secondary); font-size: 11px; margin: 0 0 6px 0; text-transform: uppercase; letter-spacing: 0.05em;">Wishlist Password</p>
                        <strong style="font-family: 'SF Mono', 'Fira Code', monospace; font-size: 1.3rem; color: var(--green-light); letter-spacing: 0.1em;">${hintPassword}</strong>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 10px 0 0 0;">
                            Save this—you'll need it to decode ${safeReceiver}'s wishlist if they share one.
                        </p>
                    </div>
                </div>
                <p style="color: var(--text-muted); margin-top: 20px; font-size: 13px; font-style: italic;">
                    Keep this assignment to yourself.
                </p>
                <div class="hints-box">
                    <h3>Create Your Wishlist</h3>
                    <p style="font-size: 13px;">Share hints with your Secret Santa</p>
                    <button class="create-hints-btn" onclick="showCreateHints('${safeGiver.replace(/'/g, "\\'")}', '${safeSalt}')">
                        Create Wishlist
                    </button>
                </div>
                <button onclick="location.href=location.pathname" style="margin-top: 16px;">
                    Start New Exchange
                </button>
            `;
        }

        function showCreateHints(recipientName, salt) {
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const hintsSection = document.getElementById('hintsSection');
            hintsSection.style.display = 'block';
            
            window.hintRecipientName = recipientName;
            window.hintSalt = salt;
            
            hintsSection.innerHTML = `
                <h1>Your Wishlist</h1>
                <div class="hints-box">
                    <p style="margin-bottom: 14px; font-size: 13px;">
                        Only your Secret Santa can decode this.
                    </p>
                    <textarea id="hintsText" placeholder="Gift ideas, preferences, sizes, favorite things..."></textarea>
                    <p id="hintLengthWarning" style="display: none; color: var(--error); font-size: 12px;"></p>
                    <button class="create-hints-btn" onclick="generateHintLink()">
                        Generate Link
                    </button>
                </div>
                <div id="hintLinkDisplay" style="display: none;"></div>
            `;
            
            document.getElementById('hintsText').addEventListener('input', function() {
                const length = this.value.length;
                const warning = document.getElementById('hintLengthWarning');
                if (length > 1500) {
                    warning.style.display = 'block';
                    warning.textContent = `Note: ${length} characters may create a long URL.`;
                } else {
                    warning.style.display = 'none';
                }
            });
        }

        async function generateHintLink() {
            const hintsText = document.getElementById('hintsText').value.trim();
            const recipientName = window.hintRecipientName;
            const salt = window.hintSalt;
            
            if (!hintsText) {
                alert('Please enter some hints for your Secret Santa!');
                return;
            }
            
            if (hintsText.length > 2000) {
                if (!confirm('Your hints are very long and may create a URL that doesn\'t work in all browsers or apps. Continue anyway?')) {
                    return;
                }
            }
            
            const hintPassword = simpleHash('pair-' + recipientName + '-' + salt).padStart(6, '0').substring(0, 6);
            
            const encoded = await encodeHints(hintsText, hintPassword);
            const hintUrl = window.location.origin + window.location.pathname + '#h-' + encoded;
            
            const display = document.getElementById('hintLinkDisplay');
            display.style.display = 'block';
            display.innerHTML = `
                <div class="hint-link-display">
                    <h3>Link Ready</h3>
                    <p style="font-size: 13px; margin: 10px 0;">
                        Share this with your group. Only your Secret Santa can decode it.
                    </p>
                    <input type="text" value="${escapeHtml(hintUrl)}" readonly id="hint-link-input" style="margin-top: 6px;">
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('hint-link-input').value, this)">Copy Link</button>
                    <div class="info-box" style="margin-top: 14px;">
                        <strong style="color: var(--text-primary);">How it works</strong><br><br>
                        Anyone can open this link, but only your assigned Santa has the password to decode it.
                    </div>
                </div>
            `;
        }

        function showViewHints(encryptedData) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            const viewHintsSection = document.getElementById('viewHintsSection');
            viewHintsSection.style.display = 'block';
            
            window.currentEncryptedData = encryptedData;
            
            viewHintsSection.innerHTML = `
                <h1>Wishlist</h1>
                <div class="hints-box">
                    <p style="margin-bottom: 14px; font-size: 13px;">
                        Enter the password to decode this wishlist.
                    </p>
                    <input type="text" id="passwordInput" placeholder="Password" maxlength="6" style="text-transform: lowercase; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 1.1rem; text-align: center; letter-spacing: 0.15em;">
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">
                        Only the assigned Secret Santa has this password
                    </p>
                    <button class="create-hints-btn" onclick="tryDecodeHintsWithPassword()">
                        Decode
                    </button>
                </div>
                <div id="decodedHints" style="margin-top: 16px;"></div>
                <button onclick="location.href=location.pathname" style="margin-top: 16px;">
                    Back
                </button>
            `;
        }

        async function tryDecodeHintsWithPassword() {
            const enteredPassword = document.getElementById('passwordInput').value.trim().toLowerCase();
            const encryptedData = window.currentEncryptedData;
            
            if (!enteredPassword) {
                alert('Please enter the password!');
                return;
            }
            
            if (enteredPassword.length < 5 || enteredPassword.length > 6) {
                alert('Password must be 5-6 characters!');
                return;
            }
            
            const decodedDiv = document.getElementById('decodedHints');
            
            // Helper function to validate and extract hints from decrypted bytes
            function validateHints(bytes) {
                if (!bytes || bytes.length < 3) return null;
                
                // Try CRC16 validation (new format): first 2 bytes are checksum
                const storedCrc = (bytes[0] << 8) | bytes[1];
                const payload = bytes.slice(2);
                const calculatedCrc = crc16(payload);
                
                if (storedCrc === calculatedCrc) {
                    return bytesToUtf8(payload);
                }
                
                // Try VALID: prefix (backward compatibility)
                try {
                    const text = bytesToUtf8(bytes);
                    if (text.startsWith('VALID:')) {
                        return text.substring(6);
                    }
                } catch (e) {}
                
                return null;
            }
            
            try {
                let hints = null;
                
                if (encryptedData.isLegacy) {
                    // Legacy format: no compression header, direct XOR, uses VALID: prefix
                    const decryptedBytes = xorDecrypt(encryptedData.bytes, enteredPassword);
                    hints = validateHints(decryptedBytes);
                    
                    // Try padded password if needed
                    if (!hints && enteredPassword.length === 5) {
                        const paddedPassword = '0' + enteredPassword;
                        const decryptedBytes2 = xorDecrypt(encryptedData.bytes, paddedPassword);
                        hints = validateHints(decryptedBytes2);
                    }
                } else {
                    // New format: has compression header
                    const decryptedBytes = xorDecrypt(encryptedData.bytes, enteredPassword);
                    const decompressed = await decompressBytes(decryptedBytes);
                    if (decompressed) {
                        hints = validateHints(decompressed);
                    }
                    
                    // Try padded password if needed
                    if (!hints && enteredPassword.length === 5) {
                        const paddedPassword = '0' + enteredPassword;
                        const decryptedBytes2 = xorDecrypt(encryptedData.bytes, paddedPassword);
                        const decompressed2 = await decompressBytes(decryptedBytes2);
                        if (decompressed2) {
                            hints = validateHints(decompressed2);
                        }
                    }
                }
                
                if (hints) {
                    decodedDiv.innerHTML = `
                        <div class="success">
                            <h3>Wishlist Decoded</h3>
                            <div style="background: var(--bg-tertiary); padding: 14px; border-radius: 2px; margin-top: 10px; text-align: left; white-space: pre-wrap; border: 1px solid var(--border); color: var(--text-secondary); line-height: 1.6; font-size: 13px;">${escapeHtml(hints.trim())}</div>
                        </div>
                    `;
                } else {
                    decodedDiv.innerHTML = `
                        <div class="error">
                            Invalid password. Only the assigned Secret Santa has the correct password.
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Decryption error:', e);
                decodedDiv.innerHTML = `
                    <div class="error">
                        Invalid password. Only the assigned Secret Santa has the correct password.
                    </div>
                `;
            }
        }

        function showError(message) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            revealSection.innerHTML = `
                <h1>Invalid Link</h1>
                <div class="error">${escapeHtml(message)}</div>
                <button onclick="location.href=location.pathname" style="margin-top: 24px;">
                    Start New Exchange
                </button>
            `;
        }

        async function checkForReveal() {
            if (window.location.hash && window.location.hash.length > 1) {
                const hash = window.location.hash.substring(1);
                
                // Handle hint links (new #h- and legacy #hints-)
                if (hash.startsWith('h-')) {
                    const encoded = hash.substring(2);
                    const encryptedData = await decodeHints(encoded);
                    
                    if (encryptedData) {
                        showViewHints(encryptedData);
                    } else {
                        showError("Invalid hint link!");
                    }
                } else if (hash.startsWith('hints-')) {
                    // Legacy format backward compatibility
                    const encoded = hash.substring(6);
                    const encryptedData = await decodeHints(encoded);
                    
                    if (encryptedData) {
                        showViewHints(encryptedData);
                    } else {
                        showError("Invalid hint link!");
                    }
                } else {
                    const data = decodeAssignment(hash);
                    
                    if (data) {
                        revealAssignment(data);
                    } else {
                        showError("Invalid Secret Santa link!");
                    }
                }
            }
        }

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('person-name')) {
                updateExclusionDropdowns();
            }
        });

        checkForReveal();
    </script>
</body>
</html>
