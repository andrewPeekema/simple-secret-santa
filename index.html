<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #5a67d8;
        }
        .person-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .person-input input {
            flex: 1;
        }
        .remove-btn {
            width: auto;
            padding: 8px 16px;
            background: #e53e3e;
        }
        .remove-btn:hover {
            background: #c53030;
        }
        #results {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .link-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .link-item strong {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .link-item input {
            font-family: monospace;
            font-size: 13px;
            background: #f7fafc;
        }
        .copy-btn {
            width: auto;
            padding: 8px 20px;
            margin-top: 8px;
            background: #48bb78;
            font-size: 14px;
        }
        .copy-btn:hover {
            background: #38a169;
        }
        #revealSection, #hintsSection, #viewHintsSection {
            text-align: center;
            padding: 40px 20px;
        }
        .reveal-box {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
        }
        .reveal-box h2 {
            color: #22543d;
            margin: 0 0 10px 0;
        }
        .reveal-name {
            font-size: 28px;
            color: #276749;
            font-weight: bold;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef5e7;
            color: #7c4700;
            padding: 12px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 14px;
        }
        .exclusions-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .exclusions-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .exclusion-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        .exclusion-row select {
            flex: 1;
        }
        .exclusion-row .remove-exclusion-btn {
            width: auto;
            padding: 8px 16px;
            background: #e53e3e;
        }
        .add-exclusion-btn {
            background: #4299e1;
            margin-top: 10px;
        }
        .add-exclusion-btn:hover {
            background: #3182ce;
        }
        .arrow {
            padding: 0 10px;
            color: #718096;
            font-size: 20px;
        }
        .help-text {
            color: #718096;
            font-size: 13px;
            margin: 5px 0;
        }
        .hints-box {
            background: #e6f7ff;
            border: 2px solid #1890ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .hints-box h3 {
            color: #0050b3;
            margin-top: 0;
        }
        .hint-link-display {
            background: #f0f5ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info-box {
            background: #e8f4f8;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .create-hints-btn {
            background: #1890ff;
            margin-top: 15px;
        }
        .create-hints-btn:hover {
            background: #40a9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÖ Secret Santa Generator</h1>
        <p class="subtitle">People picking through practically private pairings</p>
        
        <div id="setupSection">
            <h3>Add Participants (minimum 3)</h3>
            <div id="peopleList">
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
            </div>
            <button onclick="addPerson()">+ Add Person</button>
            
            <div class="exclusions-section">
                <h3>üö´ Exclusions (Optional)</h3>
                <p class="help-text">Prevent certain people from getting each other (e.g., couples, siblings)</p>
                <div id="exclusionsList"></div>
                <button class="add-exclusion-btn" onclick="addExclusion()">+ Add Exclusion Rule</button>
            </div>
            
            <button onclick="generateSecretSanta()" style="background: #48bb78; margin-top: 20px;">
                üéÅ Generate Secret Santa
            </button>
            
            <div id="results" style="display: none;">
                <h3>Share these links with each person:</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    Each person should click only their own link to see who they're giving to.
                </p>
                <div id="linksList"></div>
                <div class="warning">
                    ‚ö†Ô∏è Save these links! Once you leave this page, they cannot be regenerated with the same pairings.
                </div>
            </div>
        </div>

        <div id="revealSection" style="display: none;">
        </div>

        <div id="hintsSection" style="display: none;">
        </div>

        <div id="viewHintsSection" style="display: none;">
        </div>
    </div>

    <script>
        // Store the secret salt used for this session
        let sessionSalt = Math.random().toString(36).substring(2, 15);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // FIX: HTML escape to prevent XSS attacks
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // FIX: UTF-8 safe base64 encoding (handles emoji and international characters)
        function utf8ToBase64(str) {
            const bytes = new TextEncoder().encode(str);
            let binary = '';
            for (const byte of bytes) {
                binary += String.fromCharCode(byte);
            }
            return btoa(binary);
        }

        function base64ToUtf8(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new TextDecoder().decode(bytes);
        }

        // URL-safe base64 (no padding, URL-safe chars)
        function toUrlSafeBase64(str) {
            return utf8ToBase64(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function fromUrlSafeBase64(str) {
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) base64 += '=';
            return base64ToUtf8(base64);
        }

        // Binary-safe URL base64 (for encrypted bytes)
        function bytesToUrlSafeBase64(bytes) {
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function urlSafeBase64ToBytes(str) {
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) base64 += '=';
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        // Legacy encoding (for backward compatibility)
        function legacyDecode(str) {
            try {
                while (str.length % 4) str += '=';
                return decodeURIComponent(atob(str));
            } catch (e) {
                return null;
            }
        }

        // FIX: Modern clipboard API with fallback
        async function copyToClipboard(text, button) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                
                // Visual feedback
                const originalText = button.textContent;
                const originalBg = button.style.background;
                button.textContent = 'Copied!';
                button.style.background = '#38a169';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = originalBg || '#48bb78';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select and copy manually.');
            }
        }

        // Simple shuffle function
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Simple hash function for creating pair keys
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // ============================================
        // ENCODING FUNCTIONS
        // ============================================

        // FIX: Use JSON for assignment encoding (handles any characters in names)
        function encodeAssignment(data) {
            return toUrlSafeBase64(JSON.stringify(data));
        }

        function decodeAssignment(encoded) {
            // Try new compact JSON format first
            try {
                const decoded = fromUrlSafeBase64(encoded);
                const data = JSON.parse(decoded);
                if (data.giver && data.receiver) {
                    return data;
                }
            } catch (e) {}
            
            // Try pipe-delimited format (intermediate version)
            try {
                const decoded = fromUrlSafeBase64(encoded);
                if (decoded.includes('|') && !decoded.includes('{')) {
                    const parts = decoded.split('|');
                    if (parts.length === 4) {
                        return { giver: parts[0], receiver: parts[1], key: parts[2], salt: parts[3] };
                    }
                }
            } catch (e) {}
            
            // Fall back to legacy format
            try {
                const legacy = legacyDecode(encoded);
                if (legacy) return JSON.parse(legacy);
            } catch (e) {}
            
            return null;
        }

        // XOR encryption (operates on UTF-8 bytes)
        function xorEncrypt(text, key) {
            const textBytes = new TextEncoder().encode(text);
            const keyBytes = new TextEncoder().encode(key);
            const result = new Uint8Array(textBytes.length);
            for (let i = 0; i < textBytes.length; i++) {
                result[i] = textBytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return result;
        }

        function xorDecrypt(encryptedBytes, key) {
            const keyBytes = new TextEncoder().encode(key);
            const result = new Uint8Array(encryptedBytes.length);
            for (let i = 0; i < encryptedBytes.length; i++) {
                result[i] = encryptedBytes[i] ^ keyBytes[i % keyBytes.length];
            }
            return new TextDecoder().decode(result);
        }

        // Hint encoding
        function encodeHints(encryptedBytes) {
            return bytesToUrlSafeBase64(encryptedBytes);
        }

        function decodeHints(encoded) {
            // Check for legacy format (starts with JSON pattern)
            if (encoded.startsWith('JTdC')) {
                try {
                    const legacy = legacyDecode(encoded);
                    if (legacy) {
                        const json = JSON.parse(legacy);
                        const binary = atob(json.encrypted);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        return bytes;
                    }
                } catch (e) {}
            }
            
            // New format: direct URL-safe base64 of encrypted bytes
            try {
                return urlSafeBase64ToBytes(encoded);
            } catch (e) {
                return null;
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function addPerson() {
            const peopleList = document.getElementById('peopleList');
            const div = document.createElement('div');
            div.className = 'person-input';
            div.innerHTML = `
                <input type="text" placeholder="Enter name" class="person-name">
                <button class="remove-btn" onclick="this.parentElement.remove(); updateExclusionDropdowns();">Remove</button>
            `;
            peopleList.appendChild(div);
        }

        function addExclusion() {
            const exclusionsList = document.getElementById('exclusionsList');
            const div = document.createElement('div');
            div.className = 'exclusion-row';
            div.innerHTML = `
                <select class="person1-select">
                    <option value="">Select person...</option>
                </select>
                <span class="arrow">‚Üî</span>
                <select class="person2-select">
                    <option value="">Select person...</option>
                </select>
                <button class="remove-exclusion-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            exclusionsList.appendChild(div);
            updateExclusionDropdowns();
        }

        function updateExclusionDropdowns() {
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    people.push(name);
                }
            });

            const selects = document.querySelectorAll('.person1-select, .person2-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select person...</option>';
                people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    if (person === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        function getExclusions() {
            const exclusions = {};
            const rows = document.querySelectorAll('.exclusion-row');
            
            rows.forEach(row => {
                const person1 = row.querySelector('.person1-select').value;
                const person2 = row.querySelector('.person2-select').value;
                
                if (person1 && person2 && person1 !== person2) {
                    if (!exclusions[person1]) exclusions[person1] = [];
                    if (!exclusions[person2]) exclusions[person2] = [];
                    
                    if (!exclusions[person1].includes(person2)) {
                        exclusions[person1].push(person2);
                    }
                    if (!exclusions[person2].includes(person1)) {
                        exclusions[person2].push(person1);
                    }
                }
            });
            
            return exclusions;
        }

        function isValidAssignment(givers, receivers, exclusions) {
            for (let i = 0; i < givers.length; i++) {
                if (givers[i] === receivers[i]) {
                    return false;
                }
                if (exclusions[givers[i]] && exclusions[givers[i]].includes(receivers[i])) {
                    return false;
                }
            }
            return true;
        }

        function generateSecretSanta() {
            updateExclusionDropdowns();
            
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    people.push(name);
                }
            });

            if (people.length < 3) {
                alert('You need at least 3 people for Secret Santa!');
                return;
            }

            if (new Set(people).size !== people.length) {
                alert('Please make sure all names are unique!');
                return;
            }

            // FIX: Check for case-insensitive duplicates
            const lowerCaseNames = people.map(n => n.toLowerCase());
            const lowerCaseSet = new Set(lowerCaseNames);
            if (lowerCaseSet.size !== people.length) {
                const duplicates = people.filter((name, i) => 
                    lowerCaseNames.indexOf(name.toLowerCase()) !== i
                );
                if (!confirm(`Warning: Some names differ only by capitalization (e.g., "${duplicates[0]}"). This might cause confusion. Continue anyway?`)) {
                    return;
                }
            }

            const exclusions = getExclusions();
            
            for (let person of people) {
                const excluded = exclusions[person] || [];
                if (excluded.length >= people.length - 1) {
                    alert(`${person} has too many exclusions! They need at least one person they can give to.`);
                    return;
                }
            }

            let givers = [...people];
            let receivers = null;
            let attempts = 0;
            const maxAttempts = 1000;
            
            sessionSalt = Math.random().toString(36).substring(2, 15);
            
            while (attempts < maxAttempts) {
                receivers = shuffle([...people]);
                if (isValidAssignment(givers, receivers, exclusions)) {
                    break;
                }
                attempts++;
            }
            
            if (attempts === maxAttempts) {
                alert('Could not generate a valid Secret Santa with these exclusions. Try removing some exclusion rules.');
                return;
            }

            const assignments = {};
            for (let i = 0; i < givers.length; i++) {
                const key = Math.random().toString(36).substring(2, 8);
                const data = {
                    giver: givers[i],
                    receiver: receivers[i],
                    key: key,
                    salt: sessionSalt
                };
                assignments[givers[i]] = {
                    key: key,
                    encoded: encodeAssignment(data)
                };
            }

            displayResults(assignments);
        }

        function displayResults(assignments) {
            const linksList = document.getElementById('linksList');
            linksList.innerHTML = '';

            Object.keys(assignments).forEach(person => {
                const div = document.createElement('div');
                div.className = 'link-item';
                
                const url = window.location.origin + window.location.pathname + 
                           '#' + assignments[person].encoded;
                
                const inputId = 'link-' + Math.random().toString(36).substring(2, 8);
                
                div.innerHTML = `
                    <strong>${escapeHtml(person)}'s link (secret key: ${assignments[person].key})</strong>
                    <input type="text" value="${escapeHtml(url)}" readonly id="${inputId}">
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('${inputId}').value, this)">Copy Link</button>
                `;
                
                linksList.appendChild(div);
            });

            document.getElementById('results').style.display = 'block';
        }

        function revealAssignment(data) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            const hintPassword = simpleHash('pair-' + data.receiver + '-' + (data.salt || sessionSalt)).padStart(6, '0').substring(0, 6);
            
            // FIX: Escape all user-provided data
            const safeGiver = escapeHtml(data.giver);
            const safeReceiver = escapeHtml(data.receiver);
            const safeKey = escapeHtml(data.key);
            const safeSalt = escapeHtml(data.salt || sessionSalt);
            
            revealSection.innerHTML = `
                <h1>üéÑ Secret Santa Assignment</h1>
                <div class="reveal-box">
                    <h2>Hello, ${safeGiver}!</h2>
                    <p style="font-size: 18px; margin: 20px 0;">You are giving a gift to:</p>
                    <div class="reveal-name">üéÅ ${safeReceiver}</div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border: 2px solid #ffc107;">
                        <strong>üîë ${safeReceiver}'s Hint Password: <span style="font-family: monospace; font-size: 20px; color: #d63384;">${hintPassword}</span></strong>
                        <p style="font-size: 13px; color: #856404; margin: 8px 0 0 0;">
                            Save this! You'll need it to decode ${safeReceiver}'s wishlist hints if they share any.
                        </p>
                    </div>
                </div>
                <p style="color: #666; margin-top: 30px; font-size: 14px;">
                    Your secret key was: ${safeKey}<br>
                    Keep this assignment secret! ü§´
                </p>
                <div class="hints-box">
                    <h3>üí≠ Want to leave hints for your Secret Santa?</h3>
                    <p style="font-size: 14px; color: #0050b3;">Create an anonymous wishlist that only YOUR Secret Santa can decode!</p>
                    <button class="create-hints-btn" onclick="showCreateHints('${safeGiver.replace(/'/g, "\\'")}', '${safeSalt}')">
                        Create My Wishlist
                    </button>
                </div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px; background: #667eea;">
                    Create New Secret Santa
                </button>
            `;
        }

        function showCreateHints(recipientName, salt) {
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const hintsSection = document.getElementById('hintsSection');
            hintsSection.style.display = 'block';
            
            // Store for use in generateHintLink
            window.hintRecipientName = recipientName;
            window.hintSalt = salt;
            
            hintsSection.innerHTML = `
                <h1>üéÅ Create Your Wishlist</h1>
                <div class="hints-box">
                    <p style="color: #0050b3; margin-bottom: 20px;">
                        Your wishlist will be encrypted so only YOUR Secret Santa can read it!
                    </p>
                    <textarea id="hintsText" placeholder="Enter your gift hints, wishlist, preferences, sizes, favorite colors, etc..."></textarea>
                    <p id="hintLengthWarning" style="display: none; color: #c53030; font-size: 13px;"></p>
                    <button class="create-hints-btn" onclick="generateHintLink()">
                        Generate Anonymous Hint Link
                    </button>
                </div>
                <div id="hintLinkDisplay" style="display: none;"></div>
            `;
            
            // FIX: Add length warning for very long hints
            document.getElementById('hintsText').addEventListener('input', function() {
                const length = this.value.length;
                const warning = document.getElementById('hintLengthWarning');
                if (length > 1000) {
                    warning.style.display = 'block';
                    warning.textContent = `‚ö†Ô∏è Your hints are ${length} characters. Very long hints may create URLs that don't work in all browsers. Consider keeping it under 1000 characters.`;
                } else {
                    warning.style.display = 'none';
                }
            });
        }

        function generateHintLink() {
            const hintsText = document.getElementById('hintsText').value.trim();
            const recipientName = window.hintRecipientName;
            const salt = window.hintSalt;
            
            if (!hintsText) {
                alert('Please enter some hints for your Secret Santa!');
                return;
            }
            
            // FIX: Warn if hints are very long
            if (hintsText.length > 1500) {
                if (!confirm('Your hints are very long and may create a URL that doesn\'t work in all browsers or apps. Continue anyway?')) {
                    return;
                }
            }
            
            const hintPassword = simpleHash('pair-' + recipientName + '-' + salt).padStart(6, '0').substring(0, 6);
            
            const dataToEncrypt = 'VALID:' + hintsText;
            const encryptedBytes = xorEncrypt(dataToEncrypt, hintPassword);
            const encoded = encodeHints(encryptedBytes);
            
            const hintUrl = window.location.origin + window.location.pathname + '#hints-' + encoded;
            
            const display = document.getElementById('hintLinkDisplay');
            display.style.display = 'block';
            display.innerHTML = `
                <div class="hint-link-display">
                    <h3>‚úÖ Your hint link is ready!</h3>
                    <p style="color: #666; font-size: 14px; margin: 15px 0;">
                        Share this link with your Secret Santa group. Only the person who has YOU can decode it!
                    </p>
                    <input type="text" value="${escapeHtml(hintUrl)}" readonly id="hint-link-input" style="margin-top: 10px;">
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('hint-link-input').value, this)">Copy Hint Link</button>
                    <div class="info-box" style="margin-top: 20px;">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Anyone can click this link<br>
                        ‚Ä¢ They'll need to enter a 6-character password<br>
                        ‚Ä¢ Only YOUR Secret Santa has the correct password<br>
                        ‚Ä¢ Others will see "Invalid password!"
                    </div>
                </div>
            `;
        }

        function showViewHints(encryptedBytes) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            const viewHintsSection = document.getElementById('viewHintsSection');
            viewHintsSection.style.display = 'block';
            
            window.currentEncryptedBytes = encryptedBytes;
            
            viewHintsSection.innerHTML = `
                <h1>üéÅ Secret Wishlist</h1>
                <div class="hints-box">
                    <p style="color: #0050b3; margin-bottom: 20px;">
                        This wishlist is password-protected. Enter the password to decode it.
                    </p>
                    <input type="text" id="passwordInput" placeholder="Enter password (5-6 characters)" maxlength="6" style="text-transform: lowercase; font-family: monospace; font-size: 18px; text-align: center;">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Hint: Only the assigned Secret Santa has this password
                    </p>
                    <button class="create-hints-btn" onclick="tryDecodeHintsWithPassword()">
                        Decode Hints
                    </button>
                </div>
                <div id="decodedHints" style="margin-top: 20px;"></div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px; background: #667eea;">
                    Back to Secret Santa
                </button>
            `;
        }

        function tryDecodeHintsWithPassword() {
            const enteredPassword = document.getElementById('passwordInput').value.trim().toLowerCase();
            const encryptedBytes = window.currentEncryptedBytes;
            
            if (!enteredPassword) {
                alert('Please enter the password!');
                return;
            }
            
            if (enteredPassword.length < 5 || enteredPassword.length > 6) {
                alert('Password must be 5-6 characters!');
                return;
            }
            
            const decodedDiv = document.getElementById('decodedHints');
            
            let decrypted = xorDecrypt(encryptedBytes, enteredPassword);
            
            // If 5 chars and doesn't work, try with '0' prefix
            if (enteredPassword.length === 5 && (!decrypted || !decrypted.startsWith('VALID:'))) {
                const paddedPassword = '0' + enteredPassword;
                decrypted = xorDecrypt(encryptedBytes, paddedPassword);
            }
            
            if (decrypted && decrypted.startsWith('VALID:')) {
                const actualHints = decrypted.substring(6).trim();
                // FIX: Escape HTML to prevent XSS
                decodedDiv.innerHTML = `
                    <div class="success">
                        <h3>üéâ Success! Here's the wishlist:</h3>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px; text-align: left; white-space: pre-wrap;">${escapeHtml(actualHints)}</div>
                    </div>
                `;
            } else {
                decodedDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Invalid password! Only the assigned Secret Santa has the correct password.
                    </div>
                `;
            }
        }

        function showError(message) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            revealSection.innerHTML = `
                <h1>‚ùå Oops!</h1>
                <div class="error">${escapeHtml(message)}</div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px;">
                    Create New Secret Santa
                </button>
            `;
        }

        function checkForReveal() {
            if (window.location.hash && window.location.hash.length > 1) {
                const hash = window.location.hash.substring(1);
                
                if (hash.startsWith('hints-')) {
                    const encoded = hash.substring(6);
                    const encryptedBytes = decodeHints(encoded);
                    
                    if (encryptedBytes) {
                        showViewHints(encryptedBytes);
                    } else {
                        showError("Invalid hint link!");
                    }
                } else {
                    const data = decodeAssignment(hash);
                    
                    if (data) {
                        revealAssignment(data);
                    } else {
                        showError("Invalid Secret Santa link!");
                    }
                }
            }
        }

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('person-name')) {
                updateExclusionDropdowns();
            }
        });

        checkForReveal();
    </script>
</body>
</html>
