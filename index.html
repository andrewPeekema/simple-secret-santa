<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #5a67d8;
        }
        .person-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .person-input input {
            flex: 1;
        }
        .remove-btn {
            width: auto;
            padding: 8px 16px;
            background: #e53e3e;
        }
        .remove-btn:hover {
            background: #c53030;
        }
        #results {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .link-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .link-item strong {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .link-item input {
            font-family: monospace;
            font-size: 13px;
            background: #f7fafc;
        }
        .copy-btn {
            width: auto;
            padding: 8px 20px;
            margin-top: 8px;
            background: #48bb78;
            font-size: 14px;
        }
        .copy-btn:hover {
            background: #38a169;
        }
        #revealSection, #hintsSection, #viewHintsSection {
            text-align: center;
            padding: 40px 20px;
        }
        .reveal-box {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
        }
        .reveal-box h2 {
            color: #22543d;
            margin: 0 0 10px 0;
        }
        .reveal-name {
            font-size: 28px;
            color: #276749;
            font-weight: bold;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef5e7;
            color: #7c4700;
            padding: 12px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 14px;
        }
        .exclusions-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .exclusions-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .exclusion-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        .exclusion-row select {
            flex: 1;
        }
        .exclusion-row .remove-exclusion-btn {
            width: auto;
            padding: 8px 16px;
            background: #e53e3e;
        }
        .add-exclusion-btn {
            background: #4299e1;
            margin-top: 10px;
        }
        .add-exclusion-btn:hover {
            background: #3182ce;
        }
        .arrow {
            padding: 0 10px;
            color: #718096;
            font-size: 20px;
        }
        .help-text {
            color: #718096;
            font-size: 13px;
            margin: 5px 0;
        }
        .hints-box {
            background: #e6f7ff;
            border: 2px solid #1890ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .hints-box h3 {
            color: #0050b3;
            margin-top: 0;
        }
        .hint-link-display {
            background: #f0f5ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info-box {
            background: #e8f4f8;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .create-hints-btn {
            background: #1890ff;
            margin-top: 15px;
        }
        .create-hints-btn:hover {
            background: #40a9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÖ Secret Santa Generator</h1>
        <p class="subtitle">People picking through practically private pairings</p>
        
        <div id="setupSection">
            <h3>Add Participants (minimum 3)</h3>
            <div id="peopleList">
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
                <div class="person-input">
                    <input type="text" placeholder="Enter name" class="person-name">
                </div>
            </div>
            <button onclick="addPerson()">+ Add Person</button>
            
            <div class="exclusions-section">
                <h3>üö´ Exclusions (Optional)</h3>
                <p class="help-text">Prevent certain people from getting each other (e.g., couples, siblings)</p>
                <div id="exclusionsList"></div>
                <button class="add-exclusion-btn" onclick="addExclusion()">+ Add Exclusion Rule</button>
            </div>
            
            <button onclick="generateSecretSanta()" style="background: #48bb78; margin-top: 20px;">
                üéÅ Generate Secret Santa
            </button>
            
            <div id="results" style="display: none;">
                <h3>Share these links with each person:</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    Each person should click only their own link to see who they're giving to.
                </p>
                <div id="linksList"></div>
                <div class="warning">
                    ‚ö†Ô∏è Save these links! Once you leave this page, they cannot be regenerated with the same pairings.
                </div>
            </div>
        </div>

        <div id="revealSection" style="display: none;">
            <!-- Content will be inserted here when revealing assignment -->
        </div>

        <div id="hintsSection" style="display: none;">
            <!-- Content for creating hints -->
        </div>

        <div id="viewHintsSection" style="display: none;">
            <!-- Content for viewing hints -->
        </div>
    </div>

    <script>
        // Store the secret salt used for this session
        let sessionSalt = Math.random().toString(36).substring(2, 15);

        // Simple shuffle function
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Simple string encoding (not secure, but fine for friendly use)
        function simpleEncode(str) {
            return btoa(encodeURIComponent(str)).replace(/=/g, '');
        }

        function simpleDecode(str) {
            try {
                // Add back padding if needed
                while (str.length % 4) {
                    str += '=';
                }
                return decodeURIComponent(atob(str));
            } catch (e) {
                return null;
            }
        }

        // Simple hash function for creating pair keys
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(36);
        }

        // XOR-based "encryption" for hints (good enough for friendly use)
        function xorEncrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }

        function xorDecrypt(encoded, key) {
            try {
                const text = atob(encoded);
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch (e) {
                return null;
            }
        }

        function addPerson() {
            const peopleList = document.getElementById('peopleList');
            const div = document.createElement('div');
            div.className = 'person-input';
            div.innerHTML = `
                <input type="text" placeholder="Enter name" class="person-name">
                <button class="remove-btn" onclick="this.parentElement.remove(); updateExclusionDropdowns();">Remove</button>
            `;
            peopleList.appendChild(div);
        }

        function addExclusion() {
            const exclusionsList = document.getElementById('exclusionsList');
            const div = document.createElement('div');
            div.className = 'exclusion-row';
            div.innerHTML = `
                <select class="person1-select">
                    <option value="">Select person...</option>
                </select>
                <span class="arrow">‚Üî</span>
                <select class="person2-select">
                    <option value="">Select person...</option>
                </select>
                <button class="remove-exclusion-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            exclusionsList.appendChild(div);
            updateExclusionDropdowns();
        }

        function updateExclusionDropdowns() {
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    people.push(name);
                }
            });

            // Update all exclusion dropdowns
            const selects = document.querySelectorAll('.person1-select, .person2-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select person...</option>';
                people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    if (person === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        function getExclusions() {
            const exclusions = {};
            const rows = document.querySelectorAll('.exclusion-row');
            
            rows.forEach(row => {
                const person1 = row.querySelector('.person1-select').value;
                const person2 = row.querySelector('.person2-select').value;
                
                if (person1 && person2 && person1 !== person2) {
                    // Add bidirectional exclusions
                    if (!exclusions[person1]) exclusions[person1] = [];
                    if (!exclusions[person2]) exclusions[person2] = [];
                    
                    if (!exclusions[person1].includes(person2)) {
                        exclusions[person1].push(person2);
                    }
                    if (!exclusions[person2].includes(person1)) {
                        exclusions[person2].push(person1);
                    }
                }
            });
            
            return exclusions;
        }

        function isValidAssignment(givers, receivers, exclusions) {
            for (let i = 0; i < givers.length; i++) {
                // Check if someone got themselves
                if (givers[i] === receivers[i]) {
                    return false;
                }
                
                // Check exclusions
                if (exclusions[givers[i]] && exclusions[givers[i]].includes(receivers[i])) {
                    return false;
                }
            }
            return true;
        }

        function generateSecretSanta() {
            // Update dropdowns first to catch any last-minute name changes
            updateExclusionDropdowns();
            
            const inputs = document.querySelectorAll('.person-name');
            const people = [];
            
            // Collect names
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    people.push(name);
                }
            });

            // Validation
            if (people.length < 3) {
                alert('You need at least 3 people for Secret Santa!');
                return;
            }

            if (new Set(people).size !== people.length) {
                alert('Please make sure all names are unique!');
                return;
            }

            // Get exclusions
            const exclusions = getExclusions();
            
            // Check if the exclusions make it impossible
            for (let person of people) {
                const excluded = exclusions[person] || [];
                if (excluded.length >= people.length - 1) {
                    alert(`${person} has too many exclusions! They need at least one person they can give to.`);
                    return;
                }
            }

            // Create a valid Secret Santa pairing
            let givers = [...people];
            let receivers = null;
            let attempts = 0;
            const maxAttempts = 1000;
            
            // Generate a new session salt for this Secret Santa
            sessionSalt = Math.random().toString(36).substring(2, 15);
            
            while (attempts < maxAttempts) {
                receivers = shuffle([...people]);
                if (isValidAssignment(givers, receivers, exclusions)) {
                    break;
                }
                attempts++;
            }
            
            if (attempts === maxAttempts) {
                alert('Could not generate a valid Secret Santa with these exclusions. Try removing some exclusion rules.');
                return;
            }

            // Generate simple "encrypted" assignments
            const assignments = {};
            for (let i = 0; i < givers.length; i++) {
                // Create a simple key for each person
                const key = Math.random().toString(36).substring(2, 8);
                const data = {
                    giver: givers[i],
                    receiver: receivers[i],
                    key: key,
                    salt: sessionSalt  // Include salt for hint verification
                };
                assignments[givers[i]] = {
                    key: key,
                    encoded: simpleEncode(JSON.stringify(data))
                };
            }

            // Display the links
            displayResults(assignments);
        }

        function displayResults(assignments) {
            const linksList = document.getElementById('linksList');
            linksList.innerHTML = '';

            Object.keys(assignments).forEach(person => {
                const div = document.createElement('div');
                div.className = 'link-item';
                
                const url = window.location.origin + window.location.pathname + 
                           '#' + assignments[person].encoded;
                
                div.innerHTML = `
                    <strong>${person}'s link (secret key: ${assignments[person].key})</strong>
                    <input type="text" value="${url}" readonly id="link-${person}">
                    <button class="copy-btn" onclick="copyLink('${person}')">Copy Link</button>
                `;
                
                linksList.appendChild(div);
            });

            document.getElementById('results').style.display = 'block';
        }

        function copyLink(person) {
            const input = document.getElementById(`link-${person}`);
            input.select();
            document.execCommand('copy');
            
            // Find the button and give feedback
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#38a169';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#48bb78';
            }, 2000);
        }

        function revealAssignment(data) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            // Generate a unique hint password for this pairing
            // Using the same formula that the recipient will use when creating hints
            const hintPassword = simpleHash('pair-' + data.receiver + '-' + (data.salt || sessionSalt)).substring(0, 6);
            
            revealSection.innerHTML = `
                <h1>üéÑ Secret Santa Assignment</h1>
                <div class="reveal-box">
                    <h2>Hello, ${data.giver}!</h2>
                    <p style="font-size: 18px; margin: 20px 0;">You are giving a gift to:</p>
                    <div class="reveal-name">üéÅ ${data.receiver}</div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border: 2px solid #ffc107;">
                        <strong>üîë ${data.receiver}'s Hint Password: <span style="font-family: monospace; font-size: 20px; color: #d63384;">${hintPassword}</span></strong>
                        <p style="font-size: 13px; color: #856404; margin: 8px 0 0 0;">
                            Save this! You'll need it to decode ${data.receiver}'s wishlist hints if they share any.
                        </p>
                    </div>
                </div>
                <p style="color: #666; margin-top: 30px; font-size: 14px;">
                    Your secret key was: ${data.key}<br>
                    Keep this assignment secret! ü§´
                </p>
                <div class="hints-box">
                    <h3>üí≠ Want to leave hints for your Secret Santa?</h3>
                    <p style="font-size: 14px; color: #0050b3;">Create an anonymous wishlist that only YOUR Secret Santa can decode!</p>
                    <button class="create-hints-btn" onclick="showCreateHints('${data.giver}', '${data.salt || sessionSalt}')">
                        Create My Wishlist
                    </button>
                </div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px; background: #667eea;">
                    Create New Secret Santa
                </button>
            `;
        }

        function showCreateHints(recipientName, salt) {
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const hintsSection = document.getElementById('hintsSection');
            hintsSection.style.display = 'block';
            
            hintsSection.innerHTML = `
                <h1>üéÅ Create Your Wishlist</h1>
                <div class="hints-box">
                    <p style="color: #0050b3; margin-bottom: 20px;">
                        Your wishlist will be encrypted so only YOUR Secret Santa can read it!
                    </p>
                    <textarea id="hintsText" placeholder="Enter your gift hints, wishlist, preferences, sizes, favorite colors, etc..."></textarea>
                    <button class="create-hints-btn" onclick="generateHintLink('${recipientName}', '${salt}')">
                        Generate Anonymous Hint Link
                    </button>
                </div>
                <div id="hintLinkDisplay" style="display: none;"></div>
            `;
        }

        function generateHintLink(recipientName, salt) {
            const hintsText = document.getElementById('hintsText').value.trim();
            
            if (!hintsText) {
                alert('Please enter some hints for your Secret Santa!');
                return;
            }
            
            // The password needs to be generated as: simpleHash(GIVER + RECIPIENT + salt)
            // Since we're the recipient creating hints, we need to generate: simpleHash(TheirSecretSanta + OurName + salt)
            // But we don't know who our Secret Santa is! So we need a different approach.
            
            // We'll generate a password based on just recipient + salt, and the giver will need to 
            // recreate this same formula when they see the assignment
            // Let's use a formula that both sides can calculate independently
            const hintPassword = simpleHash('pair-' + recipientName + '-' + salt).substring(0, 6);
            
            // Add a verification prefix to check if decryption worked
            const dataToEncrypt = 'VALID:' + hintsText;
            
            // Encrypt the hints with the hint password
            const encryptedHints = xorEncrypt(dataToEncrypt, hintPassword);
            
            // Create the hint data
            const hintData = {
                encrypted: encryptedHints
            };
            
            const encoded = simpleEncode(JSON.stringify(hintData));
            const hintUrl = window.location.origin + window.location.pathname + '#hints-' + encoded;
            
            // Display the link
            const display = document.getElementById('hintLinkDisplay');
            display.style.display = 'block';
            display.innerHTML = `
                <div class="hint-link-display">
                    <h3>‚úÖ Your hint link is ready!</h3>
                    <p style="color: #666; font-size: 14px; margin: 15px 0;">
                        Share this link with your Secret Santa group. Only the person who has YOU can decode it!
                    </p>
                    <input type="text" value="${hintUrl}" readonly id="hint-link-input" style="margin-top: 10px;">
                    <button class="copy-btn" onclick="copyHintLink()">Copy Hint Link</button>
                    <div class="info-box" style="margin-top: 20px;">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Anyone can click this link<br>
                        ‚Ä¢ They'll need to enter a 6-character password<br>
                        ‚Ä¢ Only YOUR Secret Santa has the correct password<br>
                        ‚Ä¢ Others will see "Invalid password!"
                    </div>
                </div>
            `;
        }

        function copyHintLink() {
            const input = document.getElementById('hint-link-input');
            input.select();
            document.execCommand('copy');
            
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#38a169';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#48bb78';
            }, 2000);
        }

        function showViewHints(hintData) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('revealSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            const viewHintsSection = document.getElementById('viewHintsSection');
            viewHintsSection.style.display = 'block';
            
            // Store hint data for use in tryDecodeHints
            window.currentHintData = hintData;
            
            viewHintsSection.innerHTML = `
                <h1>üéÅ Secret Wishlist</h1>
                <div class="hints-box">
                    <p style="color: #0050b3; margin-bottom: 20px;">
                        This wishlist is password-protected. Enter the 6-character password to decode it.
                    </p>
                    <input type="text" id="passwordInput" placeholder="Enter 6-character password" maxlength="6" style="text-transform: lowercase; font-family: monospace; font-size: 18px; text-align: center;">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Hint: Only the assigned Secret Santa has this password
                    </p>
                    <button class="create-hints-btn" onclick="tryDecodeHintsWithPassword()">
                        Decode Hints
                    </button>
                </div>
                <div id="decodedHints" style="margin-top: 20px;"></div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px; background: #667eea;">
                    Back to Secret Santa
                </button>
            `;
        }

        function tryDecodeHintsWithPassword() {
            const enteredPassword = document.getElementById('passwordInput').value.trim().toLowerCase();
            const hintData = window.currentHintData;
            
            if (!enteredPassword) {
                alert('Please enter the password!');
                return;
            }
            
            if (enteredPassword.length !== 6) {
                alert('Password must be exactly 6 characters!');
                return;
            }
            
            const decodedDiv = document.getElementById('decodedHints');
            
            // Try to decrypt with the entered password
            const decrypted = xorDecrypt(hintData.encrypted, enteredPassword);
            
            // Check if decryption is valid by looking for our verification prefix
            if (decrypted && decrypted.startsWith('VALID:')) {
                // Remove the VALID: prefix and show the actual hints
                const actualHints = decrypted.substring(6).trim(); // Added .trim() here to remove any leading/trailing whitespace
                decodedDiv.innerHTML = `
                    <div class="success">
                        <h3>üéâ Success! Here's the wishlist:</h3>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px; text-align: left; white-space: pre-wrap;">${actualHints}</div>
                    </div>
                `;
            } else {
                decodedDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Invalid password! Only the assigned Secret Santa has the correct password.
                    </div>
                `;
            }
        }

        function showError(message) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('hintsSection').style.display = 'none';
            document.getElementById('viewHintsSection').style.display = 'none';
            const revealSection = document.getElementById('revealSection');
            revealSection.style.display = 'block';
            
            revealSection.innerHTML = `
                <h1>‚ùå Oops!</h1>
                <div class="error">${message}</div>
                <button onclick="location.href=location.pathname" style="margin-top: 20px;">
                    Create New Secret Santa
                </button>
            `;
        }

        // Check on page load for assignments or hints
        function checkForReveal() {
            if (window.location.hash && window.location.hash.length > 1) {
                const hash = window.location.hash.substring(1);
                
                // Check if it's a hint link
                if (hash.startsWith('hints-')) {
                    const encoded = hash.substring(6); // Remove 'hints-' prefix
                    const decoded = simpleDecode(encoded);
                    
                    if (decoded) {
                        try {
                            const hintData = JSON.parse(decoded);
                            showViewHints(hintData);
                        } catch (e) {
                            showError("Invalid hint link!");
                        }
                    } else {
                        showError("Invalid hint link!");
                    }
                } else {
                    // Regular assignment link
                    const decoded = simpleDecode(hash);
                    
                    if (decoded) {
                        try {
                            const data = JSON.parse(decoded);
                            revealAssignment(data);
                        } catch (e) {
                            showError("Invalid Secret Santa link!");
                        }
                    } else {
                        showError("Invalid Secret Santa link!");
                    }
                }
            }
        }

        // Update dropdowns when names change
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('person-name')) {
                updateExclusionDropdowns();
            }
        });

        // Check on page load
        checkForReveal();
    </script>
</body>
</html>
